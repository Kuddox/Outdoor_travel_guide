<!-- <h1>Attractions </h1> -->

<div class="panel panel-default">

  <% if @api_results['places'] == [] %>
    <div class="modal fade">
     <div class="modal-dialog">
      <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Sorry, nothing found.  Please try another search.</h4>
      </div>
      <div class="modal-body">
        <p>One fine body&hellip;</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary"><%= link_to 'New Search', root_path, class: "btn btn-primary" %></button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div>
    
  <% end %>  
  <% @api_results['places'].each do |place| %>
  <% place['activities'].each do |activity| %>
  
  <div class="panel-heading">
      <h5 class="panel-title"><%= place['city'] %></h5>
      <h4 class="panel-title"><%= activity['activity_type_name'] %></h4>
  </div>
  
    <div class="panel-body">
    <h4>Name</h4>
     <%= link_to place['name'], attraction_api_path(activities_unique_id: activity['unique_id']) %>

    <h4>Directions</h4>
      <%= place['directions'] %>
    
    <h4>Description</h4>
      <%= activity['description'].html_safe %>

    <div id='reviews-div'>
      <h4>Average User Rating</h4>
      <% Review.where(unique_id: activity['unique_id']).average('rating').to_i.times do %>
        <span class="glyphicon glyphicon-star"></span>
      <% end %>

      <h4>Total Reviews</h4>
      <%= Review.where(unique_id: activity['unique_id']).count %>   
    </div>
    

      <div class="footer">
        <%= link_to 'Reviews', attraction_api_path(activities_unique_id: activity['unique_id']), class: "btn btn-primary" %>
   
        <%= link_to 'Create New Trip', new_trip_path(@trip), id: 'new-trip-ajax', remote: true, class: "btn btn-primary" %>

        <%= link_to 'Add To Existing Trip', new_attraction_path(unique_id: activity['unique_id']), id: 'existing-trip-ajax', remote: true, class: "btn btn-primary" %>
      </div>
 
    </div>

  <% end %>
<% end %>

  <div id='modal-div'>
  </div>

  <div class="row">
    <div id="sidebar_builder" style='height: 450px; width: 450px; text-align: center;'></div>
  </div> 

<script>
  function createSidebarLi(json){
  return ("<li><a>" + json.name + "</a></li>");
};

function bindLiToMarker($li, marker){
  $li.on('click', function(){
    handler.getMap().setZoom(14);
    marker.setMap(handler.getMap()); //because clusterer removes map property from marker
    marker.panTo();
    google.maps.event.trigger(marker.getServiceObject(), 'click');
  })
};

function createSidebar(json_array){
  _.each(json_array, function(json){
    var $li = $( createSidebarLi(json) );
    $li.appendTo('#sidebar_container');
    bindLiToMarker($li, json.marker);
  });
};

handler = Gmaps.build('Google');
var mapOptions = { mapTypeId: google.maps.MapTypeId.HYBRID };
handler.buildMap({ provider: mapOptions, internal: {id: 'sidebar_builder'}}, function(){
  var json_array = <%= raw @markers.to_json %>;

  var markers = handler.addMarkers(json_array);

  _.each(json_array, function(json, index){
    json.marker = markers[index];
  });

  createSidebar(json_array);
  handler.bounds.extendWith(markers);
  handler.fitMapToBounds();
});
</script>


</div>

